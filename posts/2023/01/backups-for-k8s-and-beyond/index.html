<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="A unified solution for backing up my entire Kubernetes-centric homelab and all my other devices."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://jacobcolvin.com/posts/2023/01/backups-for-k8s-and-beyond/><title>Backups for K8s and Beyond :: Jacob Colvin — My Website
</title><link rel=stylesheet href=https://jacobcolvin.com/main.min.244183cde1a38e0b08f82c11791181288f9aac1cc9618cd6f4e9e7710c5768ba.css integrity="sha256-JEGDzeGjjgsI+CwReRGBKI+arBzJYYzW9OnncQxXaLo=" crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=https://jacobcolvin.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://jacobcolvin.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://jacobcolvin.com/favicon-16x16.png><link rel=manifest href=https://jacobcolvin.com/site.webmanifest><link rel=mask-icon href=https://jacobcolvin.com/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://jacobcolvin.com/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Backups for K8s and Beyond"><meta itemprop=description content="A unified solution for backing up my entire Kubernetes-centric homelab and all my other devices."><meta itemprop=datePublished content="2023-01-05T00:00:00+00:00"><meta itemprop=dateModified content="2023-01-05T00:00:00+00:00"><meta itemprop=wordCount content="1763"><meta itemprop=keywords content="Homelab,Kubernetes,K8s,Restic,k8up"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backups for K8s and Beyond"><meta name=twitter:description content="A unified solution for backing up my entire Kubernetes-centric homelab and all my other devices."><meta property="og:url" content="https://jacobcolvin.com/posts/2023/01/backups-for-k8s-and-beyond/"><meta property="og:site_name" content="Jacob Colvin"><meta property="og:title" content="Backups for K8s and Beyond"><meta property="og:description" content="A unified solution for backing up my entire Kubernetes-centric homelab and all my other devices."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-05T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-05T00:00:00+00:00"><meta property="og:see_also" content="https://jacobcolvin.com/posts/2023/04/linkerd-multi-cluster-without-a-public-ip-address/"><meta property="og:see_also" content="https://jacobcolvin.com/posts/2023/04/building-a-twin-itx-cluster/"><meta property="article:section" content="Homelab"><meta property="article:section" content="Kubernetes"><meta property="article:section" content="K8s"><meta property="article:published_time" content="2023-01-05 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=https://jacobcolvin.com/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class="logo__text logo__pathname">$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://jacobcolvin.com/about/>About</a></li><li><a href=https://jacobcolvin.com/cv/>CV</a></li><li><a href=https://jacobcolvin.com/posts/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
9 minutes</p></div><article><h1 class=post-title><a href=https://jacobcolvin.com/posts/2023/01/backups-for-k8s-and-beyond/>Backups for K8s and Beyond</a></h1><div class=post-excerpt>A unified solution for backing up my entire Kubernetes-centric homelab and all my other devices.</div><div class=post-content><h2 id=intro>Intro</h2><p>Recently I have been moving my <a href=https://github.com/MacroPower/homelab>homelab</a> to Kubernetes. This has
presented the need for a backup solution for any persistent data I might have
there. For quite some time, I have been using <a href=https://github.com/duplicati/duplicati>Duplicati</a> for my
backups, but I haven&rsquo;t been completely content with its performance, and have
heard many horror stories of restores not working properly. So, I wanted to take
this opportunity to find a backup solution that worked well for my personal
computers (I have Windows, Linux, and Darwin hosts), my storage servers (UnRaid
and FreeNAS), as well as Kubernetes. Assuming that such a solution exists, of
course!</p><h2 id=choosing-a-tool>Choosing a Tool</h2><p>There were a few solutions that I had heard mentioned lot on /r/homelab, and I
took a look at all of them. Those being <a href=https://duplicacy.com/>Duplicacy</a>, <a href=https://www.borgbackup.org/>Borg</a>,
and <a href=https://github.com/restic/restic>Restic</a>.</p><p><a href=https://duplicacy.com/>Duplicacy</a> seems like a good solution for some people, and the
interface looked very nice. However, you do need to purchase a license to use
all of its features, so I chose to avoid it unless I couldn&rsquo;t find anything else
that worked. I also wasn&rsquo;t sure how I&rsquo;d use it for any of my Kubernetes needs;
it didn&rsquo;t seem like a very popular use-case for the tool.</p><p><a href=https://www.borgbackup.org/>Borg</a> and <a href=https://github.com/restic/restic>Restic</a> both seemed like great tools. Ultimately, I
decided to go with Restic purely because of its ecosystem, but again, they both
seem like very nice solutions. Borg also probably has a better ecosystem for the
majority of users, but I believe Restic&rsquo;s is better in my particular case.</p><p>Restic didn&rsquo;t have any particularly nice client GUIs that I could find, but for
someone like me who likes to use version control as much as they can, there&rsquo;s
<a href=https://github.com/creativeprojects/resticprofile>resticprofile</a>, which is a fantastic tool that makes managing
Restic on client machines very easy, and it works very well on my Windows,
Linux, and Darwin hosts. I also found that <a href=https://github.com/emuell/restic-browser>Restic Browser</a>
could serve as a very usable GUI for doing restores. It&rsquo;s still very bare-bones,
but it does the job. Restic also has several solutions for interacting with K8s
that looked very promising. Furthermore, Restic and all of these other tools are
written in Go, which I very much prefer to Python, which is what Borg is written
in. I assume this is one of the main reasons the Kubernetes ecosystem around
Restic is so much more developed.</p><h2 id=integrating-with-kubernetes>Integrating with Kubernetes</h2><p>There are several tools out there that exist to make backing up persistent
storage on Kubernetes with Restic much easier. Typically, they are operators
that allow you define things like a backup schedule and what PVCs you want to be
in which Restic repo. Again, I took a look at three relatively popular options.</p><p>The first product that I found was <a href=https://github.com/stashed/stash>Stash</a>. Stash is interesting because
it has CRDs for a lot of different things you might want to backup or restore. I
reached out to the sales team to see what an Enterprise License would cost
(enterprise is needed for the most useful features), but they did not reply to
me, I assume because I only have a few Kubernetes nodes to my name. From there,
I was going to see if I could just build from source with license checks
disabled, but it&rsquo;s clear to me that at least some enterprise functionality isn&rsquo;t
present in the normal public repo, so that&rsquo;s off the table as well.</p><p>Another very popular choice is <a href=https://github.com/vmware-tanzu/velero>Velero</a>. However, I was immediately very
apprehensive about it because it was made by Hepito, who sold out to VMware some
time ago. This has led to a good amount of abandonware. It does look like
Velero is still being supported, but it&rsquo;s still important to realize that this
acquisition altered the goals of the project. And I would have to pray that
VMware does not alter them further. Additionally and very annoyingly, despite
heavily using Restic, Velero does not support the Restic REST server backend.
Meaning I would be hugely limited in my potential storage options.</p><p>Ultimately, I ended up going with <a href=https://github.com/k8up-io/k8up>K8up</a>. In stark contrast to the other
solutions I outlined, K8up is an active CNCF sandbox project, which makes me
much more comfortable with using it. I really didn&rsquo;t see any downsides to it for
me personally, as it included most (if not all) of the enterprise features from
Stash (such as support for backing up databases), and it also supports using the
Restic REST server as a backend, which Velero was missing.</p><h2 id=my-implementation>My Implementation</h2><p>Below is a minimized account of how I implemented everything. For all the exact,
ugly details, feel free to take a look at my <a href=https://github.com/MacroPower/homelab>homelab GitHub repo</a>.</p><p>First, I created a <code>backup</code> namespace for everything centralized:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Namespace</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>backup</span>
</span></span></code></pre></div><p>Next, I set up my Restic REST server. I used Rclone to do this, which basically
allows you to use anything that Rclone supports as storage for Restic. I ended
up creating a <a href=https://github.com/MacroPower/helm-charts/tree/main/charts/rclone>new helm chart for Rclone</a>, just because I couldn&rsquo;t
find any existing ones that I liked very much. Unlike many others, it just runs
<code>rclone rcd</code>, so you can use this chart for basically anything, and just send
commands to serve/copy/sync/etc as needed.</p><p>Basically, the only extra values I supplied were to set my config file and add
an extra port for Restic. This is my Kustomization:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>helmCharts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>rclone</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>https://jacobcolvin.com/helm-charts/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;0.3.0&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>releaseName</span>: <span style=color:#ae81ff>rclone</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>backup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>valuesInline</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>rclone/rclone</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tag</span>: <span style=color:#e6db74>&#39;1.60.1&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>configSecretName</span>: <span style=color:#ae81ff>rclone-config</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>extraPorts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>restic</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>50001</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span></code></pre></div><p>I SSHed to the container and set up my remote <code>ResticRemote</code>. Then I saved this
to my secret provider for the <code>rclone-config</code> secret, so it won&rsquo;t be lost.</p><p>I then created a Job to run the following command after the sync completes to
start the Restic server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -v -X POST -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;_async&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;_group&#34;: &#34;job/restic&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;command&#34;: &#34;serve&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;arg&#34;: [&#34;restic&#34;, &#34;ResticRemote:/&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;opt&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;addr&#34;: &#34;:50001&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span> http://rclone.backup.svc.cluster.local:5572/core/command
</span></span></code></pre></div><p>There are probably a lot of different ways to handle this, and I&rsquo;m sure it&rsquo;s
mostly down to preference. So I won&rsquo;t go into further detail on exactly how my
Job is setup and such, but if you&rsquo;re curious, it&rsquo;s all public on my GitHub repo.</p><p>For my machines I wanted to back up, I used Traefik as an ingress for this. This
is where I added things like authentication, certs, and such. Normally I use
Cloudflare to proxy traffic, but in this case I thought it&rsquo;d be better to not do
that, as I am potentially sending quite a lot of data back and forth and don&rsquo;t
want to have to deal with any potential complications there. I also use both
external-dns and cert-manager, so this was as simple as adding/replacing a few
annotations, to disable proxying and switch to my Let&rsquo;s Encrypt issuer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>&#39;external-dns.alpha.kubernetes.io/cloudflare-proxied&#39;</span>: <span style=color:#e6db74>&#39;false&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&#39;cert-manager.io/issuer&#39;</span>: <span style=color:#e6db74>&#39;letsencrypt-prod&#39;</span>
</span></span></code></pre></div><p>From there I was able to start using Restic on my personal machines. I used
resticprofile to do the vast majority of the heavy lifting here. If you would
like to see examples of the profiles I configured, you can check out my
<a href=https://github.com/MacroPower/dotfiles>dotfiles repo</a>.</p><p>Moving on to using this infrastructure to actually start backing up PVCs and
such that are also hosted by Kubernetes. First, I installed the K8up Backup
Operator. Note that the <code>resources</code> part is required, because they don&rsquo;t include
CRDs in the helm repo. You can also download the CRD and point to the file.
Also, the <code>BACKUP_GLOBAL_OPERATOR_NAMESPACE</code> environment variable is important.
It tells any Jobs in other namespaces that they should use the operator from the
<code>backup</code> namespace. Obviously, you&rsquo;d want to configure this differently if there
were lots of people using one cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>helmCharts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>k8up</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>https://k8up-io.github.io/k8up</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;4.0.1&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>releaseName</span>: <span style=color:#ae81ff>k8up</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>backup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>valuesInline</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>k8up</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>envVars</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>BACKUP_GLOBAL_OPERATOR_NAMESPACE</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>value</span>: <span style=color:#ae81ff>backup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>https://github.com/k8up-io/k8up/releases/download/k8up-4.0.1/k8up-crd.yaml</span>
</span></span></code></pre></div><p>With that installed, we can now use the <code>Schedule</code> CR to start backing things
up. While in this configuration, the operator is centralized, the <code>Schedule</code> is
not. There should be one CR in each namespace containing things you want to back
up. Here&rsquo;s an example <code>Schedule</code> for a <code>foobar</code> namespace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>k8up.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Schedule</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>foobar-schedule</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>foobar</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>rest</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://rclone-restic.backup.svc.cluster.local:50001/macropower/foobar</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>repoPasswordSecretRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>restic-credentials</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>repo-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>backup</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#39;0 4 * * *&#39;</span> <span style=color:#75715e># 04:00</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>failedJobsHistoryLimit</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>successfulJobsHistoryLimit</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>check</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#39;0 1 * * 1&#39;</span> <span style=color:#75715e># 01:00 on Monday</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>failedJobsHistoryLimit</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>successfulJobsHistoryLimit</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>prune</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#39;0 1 * * 0&#39;</span> <span style=color:#75715e># 00:00 on Monday</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>failedJobsHistoryLimit</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>successfulJobsHistoryLimit</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>retention</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>keepLast</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>keepDaily</span>: <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>keepWeekly</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>keepMonthly</span>: <span style=color:#ae81ff>12</span>
</span></span></code></pre></div><p>Note that this <code>Schedule</code> has its very own repo to use at <code>macropower/foobar</code>,
and also its own encryption key in the <code>restic-credentials</code> secret. A different
namespace with its own <code>Schedule</code> could have its own repo, credentials, or any
other attributes that aren&rsquo;t configured on the operator.</p><p>Once the <code>Schedule</code> is created, anything inside the namespace it lives in
(<code>foobar</code> in this example) can be backed up via an annotation. For example,
below I have two PVCs, one for <code>music</code> and one for <code>anime</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>music</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>foobar</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#39;k8up.io/backup&#39;</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>anime</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>foobar</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span></code></pre></div><p><code>music</code> has the backup annotation, so it will be backed up every day per our
<code>Schedule</code>. However, <code>anime</code> does not have this annotation, so it will not be
included in backups.</p><p>Here&rsquo;s a diagram showing how everything works together:</p><p><img alt="k8up diagram" src=https://jacobcolvin.com/k8up.drawio.svg></p><h2 id=databases-and-other-edge-cases>Databases and Other Edge Cases</h2><p>Lastly, to deal with databases, you of course can&rsquo;t simply backup their PVC.
Thankfully, K8up has a really simple way of addressing databases and basically
any other edge cases. You can add annotations on the Pod itself, and K8up can
run commands inside your containers to collect and backup data. Personally, I
use TimescaleDB which is backed up almost exactly in the same way as Postgres. I
was able to just add the following annotations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>podAnnotations</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#39;k8up.io/backup&#39;</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#39;k8up.io/backupcommand&#39;</span>: <span style=color:#ae81ff>sh -c &#39;PGUSER=&#34;postgres&#34; PGPASSWORD=&#34;$PATRONI_SUPERUSER_PASSWORD&#34; pg_dumpall --clean&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#39;k8up.io/file-extension&#39;</span>: <span style=color:#ae81ff>.sql</span>
</span></span></code></pre></div><p>This just creates a snapshot of the <code>db.sql</code> file resulting from the <code>pg_dump</code>
command. I am not sure how or even if I could automate restores with Timescale,
because they do require <a href=https://docs.timescale.com/timescaledb/latest/how-to-guides/backup-and-restore/pg-dump-and-restore/#restoring-an-entire-database-from-backup>a bit of extra work</a> compared to
vanilla Postgres. But, hopefully this isn&rsquo;t something I&rsquo;ll have to do very
often.</p><h2 id=conclusion>Conclusion</h2><p>I hope someone found this article helpful. If you would like to see my
exact and up-to-date implementation of everything above, please check out my homelab repo:</p><ul><li><a href=https://github.com/MacroPower/homelab>https://github.com/MacroPower/homelab</a></li></ul><p>And of course a huge thanks to the authors of the following projects:</p><ul><li><a href=https://github.com/restic/restic>Restic</a></li><li><a href=https://github.com/k8up-io/k8up>K8up</a></li><li><a href=https://github.com/creativeprojects/resticprofile>resticprofile</a></li><li><a href=https://github.com/emuell/restic-browser>Restic Browser</a></li></ul></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a href=https://jacobcolvin.com/categories/homelab/>Homelab</a></span>
<span class=tag><a href=https://jacobcolvin.com/categories/kubernetes/>Kubernetes</a></span>
<span class=tag><a href=https://jacobcolvin.com/categories/k8s/>K8s</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
1763 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2023-01-05 00:00</p></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://jacobcolvin.com/posts/2023/04/building-a-twin-itx-cluster/><span class=button__icon>←</span>
<span class=button__text>Building a Twin-ITX Cluster</span>
</a></span><span class="button next"><a href=https://jacobcolvin.com/posts/2021/07/how-to-use-grafana-and-prometheus-to-rickroll-your-friends-or-enemies/><span class=button__text>How to use Grafana and Prometheus to Rickroll your friends (or enemies)</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2024</span>
<span><a href=https://jacobcolvin.com/>Jacob Colvin</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://jacobcolvin.com/posts/index.xml target=_blank title=rss><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Made with <a href=http://gohugo.io>Hugo</a> + <a href=https://github.com/rhazdon/hugo-theme-hello-friend-ng>Hello Friend NG</a></span><span>Hosted on <a href=https://github.com/MacroPower/macropower.github.io>Pages</a></span></div></div></footer></div><script type=text/javascript src=https://jacobcolvin.com/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>